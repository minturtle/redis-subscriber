# Redis Subscriber 프레임워크 PRD

## 1. 개요

* **목적:** Redis Streams에서 메시지를 구독하고, 데코레이터를 통해 등록한 Python 함수에 메시지를 전달하는 최소 기능 프레임워크
* **언어:** Python ≥3.9
* **외부 의존:** `redis-py`, `concurrent.futures.ThreadPoolExecutor`

---

## 2. 핵심 기능

### 2.1 Redis Streams 대기

* 각 Stream별로 **별도 스레드**에서 블로킹 대기 (`XREAD`)
* 메시지 수신 시 ThreadPoolExecutor를 통해 등록 함수로 전달
* 메시지 처리 중 프레임워크는 블로킹 없이 다음 메시지 처리 가능

---

### 2.2 데코레이터를 통한 함수 등록

* 사용 예시:

```python
@subscriber.subscribe("stream1")
def handle_stream1(msg):
    ...

@subscriber.subscribe("stream2")
def handle_stream2(msg):
    ...
```

---

### 2.3 멀티스레드 구조

* **Stream Listener Thread (스레드별)**
  * 각 Stream에서 메시지 블로킹 대기

* **ThreadPoolExecutor (Worker Thread)**

  * Stream Listener에서 수신한 메시지를 병렬 처리
  * 각 메시지를 등록된 함수에 전달

**다이어그램**

```
Main Thread
   |
   +-- Stream1 Listener Thread --> ThreadPoolExecutor --> Handler Func A
   |
   +-- Stream2 Listener Thread --> ThreadPoolExecutor --> Handler Func B
```

---

### 2.4 메시지 전달 규칙

* 메시지는 Redis Stream의 `dict` 형태 그대로 전달
* 함수 호출 시: 메시지 dict가 첫 번째 인자로 전달
* Stream 이름 전달은 옵션

---

### 2.5 최소 API

```python
subscriber = RedisSubscriber(redis_url="redis://localhost:6379", max_workers=4)

@subscriber.subscribe("stream1")
def handle_stream1(msg):
    print(msg)

subscriber.start()  # Stream별 대기 스레드 시작
subscriber.stop()   # 안전하게 종료
```

---

## 3. 고려 사항

1. **에러 처리:**

   * 함수 호출 중 에러 발생 시 로그 출력
   * 메시지 손실 방지(ACK 기반이 아니므로 재처리는 제외)
2. **종료 처리:**

   * `stop()` 호출 시 모든 Stream Listener Thread 및 Worker Thread 안전 종료
3. **확장성 제한:**

   * Stream 추가/제거, 메시지 재시도, 우선순위 조정 등은 포함하지 않음

